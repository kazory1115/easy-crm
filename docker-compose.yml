services:
  # ==========================================
  # Nginx Web Server
  # ==========================================
  nginx:
    image: nginx:latest
    container_name: easy-crm-nginx
    restart: always
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - ./:/var/www/html
    ports:
      - '${NGINX_PORT}:80'
    depends_on:
      - php
    networks:
      - easy-crm-network
    environment:
      - TZ=${TIMEZONE:-Asia/Taipei}

  # ==========================================
  # PHP-FPM Application Server
  # ==========================================
  php:
    build:
      context: .
      args:
        TIMEZONE: ${TIMEZONE}
        PHP_MEMORY_LIMIT: ${PHP_MEMORY_LIMIT}
        PHP_UPLOAD_MAX_FILESIZE: ${PHP_UPLOAD_MAX_FILESIZE}
        PHP_POST_MAX_SIZE: ${PHP_POST_MAX_SIZE}
    container_name: easy-crm-php
    restart: always
    volumes:
      - ./:/var/www/html
      - ./backend:/var/www/html/backend
    environment:
      - DB_CONNECTION=${DB_CONNECTION:-pgsql}
      - DB_HOST=${DB_HOST:-postgres}
      - DB_PORT=${DB_PORT:-5432}
      - DB_DATABASE=${DB_DATABASE:-easy_crm_db}
      - DB_USERNAME=${DB_USERNAME:-postgres}
      - DB_PASSWORD=${DB_PASSWORD}
      - TZ=${TIMEZONE:-Asia/Taipei}
    depends_on:
      - postgres
      - postgres_test
      - postgres_ecic
    networks:
      - easy-crm-network

  # ==========================================
  # PostgreSQL - 主資料庫
  # ==========================================
  postgres:
    image: postgres:16-alpine
    container_name: easy-crm-postgres
    restart: always
    environment:
      POSTGRES_DB: ${DB_DATABASE:-easy_crm_db}
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD?You must set a DB_PASSWORD in the .env file}
      TZ: ${TIMEZONE:-Asia/Taipei}
      PGTZ: ${TIMEZONE:-Asia/Taipei}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - '${DB_EXTERNAL_PORT:-5432}:5432'
    networks:
      - easy-crm-network
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'pg_isready -U ${DB_USERNAME:-postgres} -d ${DB_DATABASE:-easy_crm_db}',
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # PostgreSQL - 測試資料庫
  # ==========================================
  postgres_test:
    image: postgres:16-alpine
    container_name: easy-crm-postgres-test
    restart: always
    environment:
      POSTGRES_DB: ${DB_TEST_DATABASE:-easy_crm_test}
      POSTGRES_USER: ${DB_TEST_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_TEST_PASSWORD?You must set a DB_TEST_PASSWORD in the .env file}
      TZ: ${TIMEZONE:-Asia/Taipei}
      PGTZ: ${TIMEZONE:-Asia/Taipei}
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
    ports:
      - '${DB_TEST_EXTERNAL_PORT:-5433}:5432'
    networks:
      - easy-crm-network
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'pg_isready -U ${DB_TEST_USERNAME:-postgres} -d ${DB_TEST_DATABASE:-easy_crm_test}',
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # PostgreSQL - ECIC 資料庫
  # ==========================================
  postgres_ecic:
    image: postgres:16-alpine
    container_name: easy-crm-postgres-ecic
    restart: always
    environment:
      POSTGRES_DB: ${DB_ECIC_DATABASE:-easy_crm_ecic}
      POSTGRES_USER: ${DB_ECIC_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_ECIC_PASSWORD?You must set a DB_ECIC_PASSWORD in the .env file}
      TZ: ${TIMEZONE:-Asia/Taipei}
      PGTZ: ${TIMEZONE:-Asia/Taipei}
    volumes:
      - postgres_ecic_data:/var/lib/postgresql/data
    ports:
      - '${DB_ECIC_EXTERNAL_PORT:-5434}:5432'
    networks:
      - easy-crm-network
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'pg_isready -U ${DB_ECIC_USERNAME:-postgres} -d ${DB_ECIC_DATABASE:-easy_crm_ecic}',
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # pgAdmin - PostgreSQL 管理工具
  # ==========================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: easy-crm-pgadmin
    restart: always
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@easyCRM.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD?You must set a PGADMIN_PASSWORD in the .env file}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      TZ: ${TIMEZONE:-Asia/Taipei}
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    ports:
      - '${PGADMIN_PORT:-5050}:80'
    depends_on:
      - postgres
      - postgres_test
      - postgres_ecic
    networks:
      - easy-crm-network

# ==========================================
# Networks
# ==========================================
networks:
  easy-crm-network:
    driver: bridge
    name: easy-crm-network

# ==========================================
# Volumes
# ==========================================
volumes:
  postgres_data:
    name: easy-crm-postgres-data
  postgres_test_data:
    name: easy-crm-postgres-test-data
  postgres_ecic_data:
    name: easy-crm-postgres-ecic-data
  pgadmin_data:
    name: easy-crm-pgadmin-data
