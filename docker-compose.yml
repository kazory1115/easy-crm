services:
  # ==========================================
  # Nginx Web Server
  # ==========================================
  nginx:
    image: nginx:latest
    container_name: easy-crm-nginx
    restart: always
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
      - ./:/var/www/html
    ports:
      - '${NGINX_PORT}:80'
    depends_on:
      - php
    networks:
      - easy-crm-network
    environment:
      - TZ=${TIMEZONE}

  # ==========================================
  # PHP-FPM Application Server
  # ==========================================
  php:
    build:
      context: .
      args:
        TIMEZONE: ${TIMEZONE}
        PHP_MEMORY_LIMIT: ${PHP_MEMORY_LIMIT}
        PHP_UPLOAD_MAX_FILESIZE: ${PHP_UPLOAD_MAX_FILESIZE}
        PHP_POST_MAX_SIZE: ${PHP_POST_MAX_SIZE}
    container_name: easy-crm-php
    restart: always
    volumes:
      - ./:/var/www/html
      - ./backend:/var/www/html/backend
    environment:
      - DB_CONNECTION=${DB_CONNECTION}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - TZ=${TIMEZONE}
    depends_on:
      - mysql
      - mysql_test
      - mysql_ecic
    networks:
      - easy-crm-network

  # ==========================================
  # MySQL - 主資料庫
  # ==========================================
  mysql:
    image: mysql:8.0
    container_name: easy-crm-mysql
    restart: always
    environment:
      MYSQL_DATABASE: ${DB_DATABASE}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD?You must set a DB_ROOT_PASSWORD in the .env file}
      TZ: ${TIMEZONE}
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    volumes:
      - mysql_data:/var/lib/mysql
    ports:
      - '${DB_EXTERNAL_PORT}:3306'
    networks:
      - easy-crm-network
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost', '-u', 'root', '-p${DB_ROOT_PASSWORD}']
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # MySQL - 測試資料庫
  # ==========================================
  mysql_test:
    image: mysql:8.0
    container_name: easy-crm-mysql-test
    restart: always
    environment:
      MYSQL_DATABASE: ${DB_TEST_DATABASE}
      MYSQL_ROOT_PASSWORD: ${DB_TEST_ROOT_PASSWORD?You must set a DB_TEST_ROOT_PASSWORD in the .env file}
      TZ: ${TIMEZONE}
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    volumes:
      - mysql_test_data:/var/lib/mysql
    ports:
      - '${DB_TEST_EXTERNAL_PORT}:3306'
    networks:
      - easy-crm-network
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost', '-u', 'root', '-p${DB_TEST_ROOT_PASSWORD}']
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # MySQL - ECIC 資料庫
  # ==========================================
  mysql_ecic:
    image: mysql:8.0
    container_name: easy-crm-mysql-ecic
    restart: always
    environment:
      MYSQL_DATABASE: ${DB_ECIC_DATABASE}
      MYSQL_ROOT_PASSWORD: ${DB_ECIC_ROOT_PASSWORD?You must set a DB_ECIC_ROOT_PASSWORD in the .env file}
      TZ: ${TIMEZONE}
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    volumes:
      - mysql_ecic_data:/var/lib/mysql
    ports:
      - '${DB_ECIC_EXTERNAL_PORT}:3306'
    networks:
      - easy-crm-network
    healthcheck:
      test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost', '-u', 'root', '-p${DB_ECIC_ROOT_PASSWORD}']
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # phpMyAdmin - MySQL 管理工具
  # ==========================================
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: easy-crm-phpmyadmin
    restart: always
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_ARBITRARY: 1
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD?You must set a DB_ROOT_PASSWORD in the .env file}
      TZ: ${TIMEZONE}
    ports:
      - '${PHPMYADMIN_PORT}:80'
    depends_on:
      - mysql
      - mysql_test
      - mysql_ecic
    networks:
      - easy-crm-network

# ==========================================
# Networks
# ==========================================
networks:
  easy-crm-network:
    driver: bridge
    name: easy-crm-network

# ==========================================
# Volumes
# ==========================================
volumes:
  mysql_data:
    name: easy-crm-mysql-data
  mysql_test_data:
    name: easy-crm-mysql-test-data
  mysql_ecic_data:
    name: easy-crm-mysql-ecic-data
