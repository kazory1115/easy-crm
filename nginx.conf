server {
    listen 80;
    server_name localhost;

    # 日誌配置
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # === Laravel API (Backend) ===
    # 處理所有 /api/ 開頭的請求
    location ^~ /api/ {
        # 使用 alias 將 /api/ 映射到 backend/public/
        alias /var/www/html/backend/public/;

        # Laravel 前端控制器模式：所有請求都傳給 index.php
        # 去掉 $uri/ 避免目錄索引錯誤
        try_files $uri @api;

        # 處理 .php 文件（如果你需要直接訪問 PHP 文件的話）
        location ~ \.php$ {
            fastcgi_pass php:9000;
            fastcgi_index index.php;

            # 使用 $request_filename (alias 會自動計算正確路徑)
            fastcgi_param SCRIPT_FILENAME $request_filename;

            include fastcgi_params;
            fastcgi_param SCRIPT_NAME $fastcgi_script_name;
        }
    }

    # Laravel API 前端控制器：處理所有未找到的 API 請求
    location @api {
        fastcgi_pass php:9000;
        fastcgi_index index.php;

        # 指定 Laravel 的入口文件
        fastcgi_param SCRIPT_FILENAME /var/www/html/backend/public/index.php;
        fastcgi_param SCRIPT_NAME /index.php;

        # 標準 FastCGI 參數
        include fastcgi_params;

        # 覆蓋關鍵參數
        fastcgi_param DOCUMENT_ROOT /var/www/html/backend/public;
        fastcgi_param REQUEST_URI $request_uri;

        # PHP 特定設定
        fastcgi_buffer_size 128k;
        fastcgi_buffers 256 16k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;
        fastcgi_read_timeout 240;
    }

    # 處理 /api（無斜槓）- 重定向到 /api/
    location = /api {
        return 301 /api/;
    }

    # === Vue App (Frontend) ===
    # 處理所有非 API 的請求
    location / {
        root /var/www/html/frontend/dist;
        index index.html;

        # 先檢查檔案是否存在
        try_files $uri $uri/ =404;

        # 支援 Vue Router 的 history mode
        error_page 404 /index.html;
    }

    # === Security: 拒絕訪問隱藏文件 ===
    location ~ /\.(?!well-known).* {
        deny all;
    }

    # === Security: 拒絕訪問敏感文件 ===
    location ~* \.(env|git|gitignore|htaccess)$ {
        deny all;
    }
}
